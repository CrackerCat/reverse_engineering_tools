# How to debug Windows malware on cloud machines without virtualization using QEMU

This setup is extremely useful for malware debugging where the host machine doesn't support virtualization, mainly applicable to cloud instances. Another common drawback of them is the lack of CPU/memory snapshots. As the guest machine here may have a network connection with the host, it is important that the host machine is isolated from any other machine and preferably the rest of the Internet.

1. Install Windows ADK and the Windows PE addon.
2. Start *"Deployment and Imaging Tools Environment"* as an Administrator (can be found in the Start Menu).
3. Create an image:

`copype amd64 C:\WinPE_amd64`

4. Mount its root:

`Dism /Mount-Image /ImageFile:"C:\WinPE_amd64\media\sources\boot.wim" /index:1 /MountDir:"C:\WinPE_amd64\mount"`

5. Copy required tools *to "C:\WinPE_amd64\mount"*, for example, radare2, Python and wget.
6. Optionally, update *\windows\system32\startnet.cmd* to include their paths to *PATH* env variable.
7. Install virtio drivers from https://docs.fedoraproject.org/en-US/quick-docs/creating-windows-virtual-machines-using-virtio-drivers/index.html:

`Dism /Image:C:\WinPE_amd64\mount /Add-Driver /Driver:<path_to_unpacked_iso_dir> /Recurse`

8. Unmount an image:

`Dism /Unmount-Image /MountDir:"C:\WinPE_amd64\mount" /commit`

9. Generate a bootable ISO file from it:

`MakeWinPEMedia /ISO C:\WinPE_amd64 C:\work\WinPE_amd64.iso`

10. Transfer it to the host where the analysis will be performed.
11. Install QEMU there.
12. Create a new disk image:

`qemu-img create -f qcow2 win10.qcow2 10G`

13. Boot the image using the following command. It may take a few minutes to start:

`qemu-system-x86_64.exe -boot d -m 2048 -cdrom "c:\debug\WinPE_amd64.iso" -drive file=c:\debug\win10.qcow2,if=virtio -device e1000,netdev=mynet0 -netdev user,id=mynet0`

14. Format the disk image using *diskutil* and assign a letter to it. Now it can be used to transfer files back to the host and create snapshots. All changes are committed to the disk when the QEMU session is closed gracefully using "exit" command in the *cmd.exe*.
15. Samples for analysis can be downloaded from the host (10.0.2.2) where they can be shared with Python's *SimpleHTTPServer* (*http.server* on Python 3). For extra security, it is recommended to restart the emulation with the network disabled once the samples are transferred and saved on a disk.
16. In case of *radare2*, use `r2 -d <sample>` command line for debugging.
17. Memory snapshots can be listed, created, restored and deleted in the QEMU Monitor (Ctrl+Alt+2 in the UI to switch to it); *info snapshots*, *savevm*, *loadvm* and *delvm* commands respectively.
18. It would be nice if Samba could be used to transfer files and *hostfwd* option worked for remote IDA debugging, but with Windows host and Windows guest, these options don't seem to work with a *user* network interface. Using a *tap* interface might be problematic on the remote machine as creating a bridge may kill the connection.
