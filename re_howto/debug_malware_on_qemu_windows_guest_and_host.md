# How to debug malware using QEMU with Windows guest and host

This setup is extremely useful for safe malware debugging where the host machine doesn't support virtualization

1. install Windows ADK and the Windows PE addon
2. start *"Deployment and Imaging Tools Environment"* as an Administrator (can be found in the Start Menu)
3. create an image:

`copype amd64 C:\WinPE_amd64`

4. mount its root:

`Dism /Mount-Image /ImageFile:"C:\WinPE_amd64\media\sources\boot.wim" /index:1 /MountDir:"C:\WinPE_amd64\mount"`

5. copy required tools *to "C:\WinPE_amd64\mount"*, for example, radare2, Python and wget
6. optionally, update *\windows\system32\startnet.cmd* to include their paths to PATH env variable
7. install virtio drivers from https://docs.fedoraproject.org/en-US/quick-docs/creating-windows-virtual-machines-using-virtio-drivers/index.html:

`Dism /Image:C:\WinPE_amd64\mount /Add-Driver /Driver:<path_to_unpacked_iso_dir> /Recurse`

8. unmount an image:

`Dism /Unmount-Image /MountDir:"C:\WinPE_amd64\mount" /commit`

9. generate a bootable ISO file from it:

`MakeWinPEMedia /ISO C:\WinPE_amd64 C:\work\WinPE_amd64.iso`

10. transfer it to the host where the analysis will be performed
11. install QEMU there
12. create a new disk image:

`qemu-img create -f qcow2 win10.qcow2 10G`

13. boot the image using the following command. It may take a few minutes to start:

`qemu-system-x86_64.exe -boot d -m 2048 -cdrom "c:\debug\WinPE_amd64.iso" -drive file=c:\debug\win10.qcow2,if=virtio -device e1000,netdev=mynet0 -netdev user,id=mynet0`

14. format the disk image using *diskutil* and assign a letter to it. Now it can be used to transfer files back to the host and create snapshots. All changes are committed when the session is closed gracefully using "exit" command
15. samples for analysis can be downloaded from the host (10.0.2.2) where they can be shared with Python's *SimpleHTTPServer* (*http.server* on Python 3)
16. in case of *radare2*, use `r2 -d <sample>` command line for debugging
17. memory snapshots can be listed, created, restored and deleted in the QEMU Monitor (Ctrl+Alt+2 in the UI to switch to it); *info snapshots*, *savevm*, *loadvm* and *delvm* commands respectively.
18. it would be nice if smb option could be used to transfer files and hostfwd option worked for remote IDA debugging, but with Windows host and Windows guest, these options don't seem to work with a user network interface. Using a tap interface might be problematic on the remote machine as creating a bridge may kill the connection
